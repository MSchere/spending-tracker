// Spending Tracker - Financial Dashboard Schema
// Stack: Next.js 16, Prisma, NextAuth, PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// Enums
// ============================================================================

enum Currency {
  EUR
  USD
  GBP
  CHF
  JPY
  CAD
  AUD
  BRL
}

// ============================================================================
// User Model (NextAuth compatible - credentials only)
// ============================================================================

model User {
  id               String    @id @default(cuid())
  email            String    @unique
  password         String    // bcrypt hashed
  name             String?
  twoFactorSecret  String?   // Encrypted TOTP secret
  twoFactorEnabled Boolean   @default(false)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  wiseProfiles     WiseProfile[]
  budgets          Budget[]
  savingsGoals     SavingsGoal[]
  indexaAccounts   IndexaAccount[]
  tangibleAssets   TangibleAsset[]
  financialAssets  FinancialAsset[]
  preferences      UserPreferences?
}

model UserPreferences {
  id        String   @id @default(cuid())
  userId    String   @unique
  locale    String   @default("es-ES") // BCP 47 locale tag
  currency  Currency @default(EUR)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ============================================================================
// Wise Integration
// ============================================================================

model WiseProfile {
  id         String    @id @default(cuid())
  userId     String
  profileId  BigInt    @unique // Wise profile ID
  type       String // PERSONAL or BUSINESS
  lastSyncAt DateTime?
  createdAt  DateTime  @default(now())

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  balances     WiseBalance[]
  transactions Transaction[]
}

model WiseBalance {
  id            String   @id @default(cuid())
  wiseBalanceId BigInt   @unique // Wise balance ID
  profileId     String
  currency      String   // ISO currency code (from Wise API, may include currencies we don't support)
  amount        Decimal  @db.Decimal(18, 4)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  profile WiseProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
}

// ============================================================================
// Core Financial Models
// ============================================================================

model Transaction {
  id                 String          @id @default(cuid())
  wiseRefNumber      String?         @unique // Wise reference for dedup
  profileId          String
  type               TransactionType
  amount             Decimal         @db.Decimal(18, 4)
  currency           String          // Original currency from source (may include currencies we don't support)
  amountEur          Decimal         @db.Decimal(18, 4) // Converted to EUR
  description        String?
  date               DateTime
  categoryId         String?
  isRecurring        Boolean         @default(false)
  recurringExpenseId String?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt

  profile          WiseProfile?      @relation(fields: [profileId], references: [id], onDelete: Cascade)
  category         Category?         @relation(fields: [categoryId], references: [id])
  recurringExpense RecurringExpense? @relation(fields: [recurringExpenseId], references: [id])

  @@index([date])
  @@index([categoryId])
  @@index([type])
}

enum TransactionType {
  INCOME
  EXPENSE
  TRANSFER
  INVESTMENT
}

model Category {
  id        String       @id @default(cuid())
  name      String       @unique
  icon      String? // Lucide icon name
  color     String? // Hex color
  type      CategoryType
  isSystem  Boolean      @default(true) // Predefined categories
  createdAt DateTime     @default(now())

  transactions      Transaction[]
  budgets           Budget[]
  keywords          CategoryKeyword[]
  recurringExpenses RecurringExpense[]
}

enum CategoryType {
  FIXED_EXPENSE // Rent, utilities, subscriptions
  VARIABLE_EXPENSE // Food, clothing, entertainment
  INCOME // Salary, freelance, etc.
  INVESTMENT // Index funds, ETFs, stocks, crypto
  TRANSFER // Internal transfers (not counted in budget)
}

model CategoryKeyword {
  id         String @id @default(cuid())
  categoryId String
  keyword    String

  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([categoryId, keyword])
}

model Budget {
  id         String       @id @default(cuid())
  userId     String
  categoryId String
  amount     Decimal      @db.Decimal(18, 4)
  currency   Currency     @default(EUR)
  period     BudgetPeriod
  startDate  DateTime
  isActive   Boolean      @default(true)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
}

enum BudgetPeriod {
  WEEKLY
  MONTHLY
  YEARLY
}

model SavingsGoal {
  id            String          @id @default(cuid())
  userId        String
  name          String
  targetAmount  Decimal         @db.Decimal(18, 4)
  currentAmount Decimal         @db.Decimal(18, 4) @default(0)
  currency      Currency        @default(EUR)
  deadline      DateTime?
  type          SavingsGoalType
  isCompleted   Boolean         @default(false)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum SavingsGoalType {
  EMERGENCY_FUND
  SAVINGS
  INDEX_FUND
  ETF
  STOCK
  CRYPTO
}

model RecurringExpense {
  id          String             @id @default(cuid())
  name        String
  type        RecurringType      @default(EXPENSE)
  amount      Decimal            @db.Decimal(18, 4)
  currency    Currency           @default(EUR)
  frequency   RecurringFrequency
  nextDueDate DateTime
  categoryId  String?
  isActive    Boolean            @default(true)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  category     Category?     @relation(fields: [categoryId], references: [id])
  transactions Transaction[]
}

enum RecurringType {
  EXPENSE
  INCOME
}

enum RecurringFrequency {
  WEEKLY
  BIWEEKLY
  MONTHLY
  BIMONTHLY
  QUARTERLY
  YEARLY
}

// ============================================================================
// Exchange Rates & Settings
// ============================================================================

model ExchangeRate {
  id           String   @id @default(cuid())
  fromCurrency String   // ISO currency code (may include external currencies)
  toCurrency   String   // ISO currency code (may include external currencies)
  rate         Decimal  @db.Decimal(18, 8)
  date         DateTime @db.Date
  createdAt    DateTime @default(now())

  @@unique([fromCurrency, toCurrency, date])
}

model AppSettings {
  id              String   @id @default("settings")
  primaryCurrency Currency @default(EUR)
  lastSyncAt      DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model SyncLog {
  id                String     @id @default(cuid())
  status            SyncStatus
  transactionsAdded Int        @default(0)
  errorMessage      String?
  createdAt         DateTime   @default(now())
}

enum SyncStatus {
  SUCCESS
  FAILED
  PARTIAL
}

// ============================================================================
// Indexa Capital Integration
// ============================================================================

model IndexaAccount {
  id              String    @id @default(cuid())
  userId          String
  accountNumber   String    @unique // e.g., "PBKLBYZ5"
  accountType     String             // "mutual" or "pension"
  status          String             // "active", etc.
  riskLevel       Int?               // 1-10
  netContributions Decimal? @db.Decimal(18, 4) // Total deposits - withdrawals (Aportaciones)
  lastSyncAt      DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user      User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  snapshots IndexaPortfolioSnapshot[]
}

model IndexaPortfolioSnapshot {
  id             String   @id @default(cuid())
  accountId      String
  date           DateTime @db.Date
  totalValue     Decimal  @db.Decimal(18, 4) // Current portfolio value
  totalInvested  Decimal  @db.Decimal(18, 4) // Amount contributed
  returns        Decimal  @db.Decimal(18, 4) // Profit/loss in EUR
  returnsPercent Decimal  @db.Decimal(8, 4)  // Return percentage
  createdAt      DateTime @default(now())

  account  IndexaAccount   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  holdings IndexaHolding[]

  @@unique([accountId, date])
}

model IndexaHolding {
  id             String  @id @default(cuid())
  snapshotId     String
  instrumentName String  // "Vanguard Global Stock", etc.
  instrumentType String  // "Stocks", "Bonds", "Cash", etc.
  isin           String?
  shares         Decimal @db.Decimal(18, 8)
  value          Decimal @db.Decimal(18, 4)
  weight         Decimal @db.Decimal(5, 2) // Portfolio percentage

  snapshot IndexaPortfolioSnapshot @relation(fields: [snapshotId], references: [id], onDelete: Cascade)
}

// ============================================================================
// Tangible Assets (Physical assets that depreciate over time)
// ============================================================================

enum TangibleAssetCategory {
  VEHICLE
  REAL_ESTATE
  ELECTRONICS
  FURNITURE
  JEWELRY
  COLLECTIBLES
  OTHER
}

enum DepreciationMethod {
  STRAIGHT_LINE     // Linear: (Cost - Salvage) / Useful Life per year
  DECLINING_BALANCE // Accelerated: Fixed % of remaining value per year
  NONE              // No depreciation (real estate, collectibles)
  MANUAL            // User enters valuations manually
}

model TangibleAsset {
  id                 String                @id @default(cuid())
  userId             String
  name               String                // "2015 Peugeot 308"
  description        String?
  category           TangibleAssetCategory
  purchaseDate       DateTime              @db.Date
  purchasePrice      Decimal               @db.Decimal(18, 4)
  currency           Currency              @default(EUR)
  depreciationMethod DepreciationMethod    @default(STRAIGHT_LINE)
  usefulLifeYears    Int?                  // For automatic depreciation
  salvageValue       Decimal?              @db.Decimal(18, 4) // Residual value at end of life
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt

  user       User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  valuations TangibleAssetValuation[]

  @@index([userId])
}

model TangibleAssetValuation {
  id        String   @id @default(cuid())
  assetId   String
  date      DateTime @db.Date
  value     Decimal  @db.Decimal(18, 4)
  note      String?  // "Annual checkup", "Market adjustment"
  createdAt DateTime @default(now())

  asset TangibleAsset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@unique([assetId, date])
  @@index([assetId])
}

// ============================================================================
// Financial Assets (Stocks, Crypto, ETFs - with Alpha Vantage price tracking)
// ============================================================================

enum FinancialAssetType {
  STOCK
  CRYPTO
  ETF
}

model FinancialAsset {
  id            String             @id @default(cuid())
  userId        String
  symbol        String             // "AAPL", "BTC", "VOO"
  name          String             // "Apple Inc.", "Bitcoin", "Vanguard S&P 500 ETF"
  type          FinancialAssetType
  shares        Decimal            @db.Decimal(18, 8) // Supports fractional shares & crypto
  avgCostBasis  Decimal            @db.Decimal(18, 4) // Average cost per share/unit
  currency      Currency           @default(USD)      // Price currency
  lastPrice     Decimal?           @db.Decimal(18, 4) // Latest price from API
  lastPriceAt   DateTime?          // When price was last updated
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  user   User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  prices FinancialAssetPrice[]

  @@unique([userId, symbol, type])
  @@index([userId])
}

model FinancialAssetPrice {
  id        String   @id @default(cuid())
  assetId   String
  date      DateTime @db.Date
  price     Decimal  @db.Decimal(18, 4)
  createdAt DateTime @default(now())

  asset FinancialAsset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@unique([assetId, date])
  @@index([assetId])
}
